#!/usr/bin/env node
// Git Hooks Setup Script
// Automatically installs pre-commit hook for CSS minification

const fs = require('fs');
const path = require('path');

const ROOT_DIR = path.join(__dirname, '..');
const GIT_HOOKS_DIR = path.join(ROOT_DIR, '.git', 'hooks');
const PRE_COMMIT_PATH = path.join(GIT_HOOKS_DIR, 'pre-commit');

// ============================================
// Pre-commit Hook Content
// ============================================

const PRE_COMMIT_HOOK = `#!/bin/sh
# Auto-minify CSS before commit
# Generated by _scripts/setup-git-hooks.js

echo "üîç Checking for CSS changes..."

# Check if any .css files (except .min.css) are staged
CSS_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\\.css$' | grep -v '\\.min\\.css$')

if [ -n "$CSS_CHANGED" ]; then
  echo "üìù CSS files changed - auto-minifying..."

  # Run minification
  node _scripts/auto-minify-css.js

  if [ $? -eq 0 ]; then
    echo "‚úÖ CSS minified successfully"

    # Add minified files to staging
    git add style.min.css style-404.min.css 2>/dev/null

    echo "‚úì Minified files staged for commit"
  else
    echo "‚ùå CSS minification failed - commit aborted"
    exit 1
  fi
else
  echo "‚úì No CSS changes detected"
fi

echo ""
`;

// ============================================
// Install Hook
// ============================================

function installHook() {
  console.log('üîß Installing Git Pre-Commit Hook\n');

  // Check if .git directory exists
  if (!fs.existsSync(GIT_HOOKS_DIR)) {
    console.error('‚ùå Error: .git/hooks directory not found');
    console.error('   Make sure you are in a git repository');
    process.exit(1);
  }

  // Backup existing hook if it exists
  if (fs.existsSync(PRE_COMMIT_PATH)) {
    const backupPath = PRE_COMMIT_PATH + '.backup';
    console.log('üì¶ Backing up existing pre-commit hook...');
    fs.copyFileSync(PRE_COMMIT_PATH, backupPath);
    console.log(`   Backup saved: ${backupPath}\n`);
  }

  // Write new hook
  fs.writeFileSync(PRE_COMMIT_PATH, PRE_COMMIT_HOOK, { mode: 0o755 });
  console.log('‚úÖ Pre-commit hook installed successfully!\n');

  console.log('üìã How it works:');
  console.log('   1. You edit style.css (or style-404.css)');
  console.log('   2. You run: git add style.css');
  console.log('   3. You run: git commit -m "message"');
  console.log('   4. Hook automatically:');
  console.log('      - Minifies CSS files');
  console.log('      - Stages minified files (style.min.css)');
  console.log('      - Includes them in your commit\n');

  console.log('üéØ Recommended workflow:');
  console.log('   - ALWAYS edit style.css (source)');
  console.log('   - NEVER edit style.min.css manually');
  console.log('   - Minification happens automatically on commit\n');

  console.log('üîÑ Optional: Watch mode for development');
  console.log('   Run: node _scripts/auto-minify-css.js --watch');
  console.log('   This will auto-minify on every save while coding\n');

  console.log('üéâ Setup complete!');
}

// ============================================
// Uninstall Hook
// ============================================

function uninstallHook() {
  console.log('üóëÔ∏è  Uninstalling Git Pre-Commit Hook\n');

  if (!fs.existsSync(PRE_COMMIT_PATH)) {
    console.log('‚úì No pre-commit hook found (already uninstalled)');
    return;
  }

  // Remove hook
  fs.unlinkSync(PRE_COMMIT_PATH);
  console.log('‚úÖ Pre-commit hook removed\n');

  // Restore backup if exists
  const backupPath = PRE_COMMIT_PATH + '.backup';
  if (fs.existsSync(backupPath)) {
    fs.copyFileSync(backupPath, PRE_COMMIT_PATH);
    fs.unlinkSync(backupPath);
    console.log('üì¶ Previous hook restored from backup');
  }
}

// ============================================
// Main Execution
// ============================================

const command = process.argv[2];

if (command === 'uninstall') {
  uninstallHook();
} else {
  installHook();
}
